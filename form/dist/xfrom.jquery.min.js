function xCombo(e){this.opts={},this.eles={},this.selectedItems=[],this.isFirstTime=!0}function xSelect(e){this.opts=e||{},this.eles={$selector:null,$ul:null}}xCombo.prototype.render=function(opts){var me=this;this.opts=opts;var $selector=opts.selector,tField=opts.tField||"text",vField=opts.vField||"value",pField=opts.vField||"parent",subNode=opts.subNode,value=opts.value||"",isMultiSelect=opts.isMultiSelect||"N",data=opts.data,onFilter=opts.onFilter,onSelect=opts.onSelect,onShow=opts.onShow,onHide=opts.onHide,onLoadData=opts.onLoadData;this.eles.$ul=jQuery("<ul></ul"),$selector.append(this.eles.$ul),this.eles.$text=jQuery(">input",$selector),this.eles.$selector=$selector,this.eles.$hValue=jQuery('<input type="hidden" />');var name=this.eles.$text.attr("name");name&&(this.eles.$hValue.attr("name",name),this.eles.$text.attr("name",name+"Desc")),this.eles.$hValue.val(this.opts.value),$selector.append(this.eles.$hValue),this.eles.$selector.on("click",function(e){var t=me.eles.$ul.is(":visible");t?me.hide():me.show(),e.stopPropagation()}),this.eles.$text.keyup(function(e){var t=jQuery(this).val();me.selectedItems=[],me.clearValue(),me.renderItems(me.opts.data,function(e,o){return me.getParentFilterExpress(e)&&o.indexOf(t)>-1})}),this.eles.$ul.hover(function(){},function(){me.hide()}),this.opts.onLoadData?(this.eles.$ul.append("<li>数据加载中...</li>"),eval(this.opts.onLoadData+".call(this)")):(this.setValue(value),this.renderItems(opts.data))},xCombo.prototype.onFilter=function(e){return!0},xCombo.prototype.isMultiSelect=function(){return"Y"==this.opts.isMultiSelect},xCombo.prototype.getData=function(){return[]},xCombo.prototype.refresh=function(e){this.opts.data=e,this.eles.$ul.append("<li>数据加载中...</li>"),this.setValue(this.getValue()),this.renderItems(e)},xCombo.prototype.renderItems=function(e,t){if(e&&0!=e.length){var o=this;this.eles.$ul.empty();for(var s=0;s<e.length;s++){var i=e[s];!function(e){var s,i,r;if("string"==typeof e?s=i=e:(s=e[o.opts.tField],i=e[o.opts.vField],r=e[o.opts.pField]),!t||0!=t(e,s)){var l=jQuery("<li></li>");o.opts.renderItem&&l.append(o.opts.renderItem(e,s)),o.isMultiSelect()&&l.addClass("item"),l.html(s),l.attr("value",i),l.attr(o.opts.pField,r),l.click(function(t){if(i!=o.getValue()){if("Y"==o.opts.isMultiSelect){var r=l.hasClass("active");r?(o.removeItem(e),l.removeClass("active")):(o.addItem(e),l.addClass("active"))}else o.hide(),o.selectedItems=[],l.siblings().removeClass("active"),l.addClass("active"),o.setValue(i,s);t.stopPropagation()}}),jQuery.inArray(e,o.selectedItems)>-1&&l.addClass("active"),o.eles.$ul.append(l)}}(i)}}},xCombo.prototype.show=function(){this.FilterForParent(),this.eles.$ul.show()},xCombo.prototype.hide=function(){this.eles.$selector.attr("isValid",this.selectedItems.length>0?"Y":"N"),this.eles.$ul.hide()},xCombo.prototype.getValue=function(){return this.eles.$hValue.val()},xCombo.prototype.addItem=function(e){this.selectedItems.push(e),this.renderValue()},xCombo.prototype.removeItem=function(e){for(var t=0;t<this.selectedItems.length;t++){var o=this.selectedItems[t];o==e&&this.selectedItems.splice(t,1)}this.renderValue()},xCombo.prototype.selectedItems=[],xCombo.prototype.setValue=function(e,t){var o=this;if(t&&this.eles.$text.val(t),this.opts&&this.opts.data)for(var s=0;s<this.opts.data.length;s++){var i,r=this.opts.data[s];i="string"==typeof r?r:r[o.opts.vField],i&&e.toString().indexOf(i.toString())>-1&&this.selectedItems.push(r)}this.renderValue()},xCombo.prototype.clearValue=function(){this.eles.$hValue.val(""),this.setSubCombo()},xCombo.prototype.renderValue=function(){for(var e=this,t=[],o=[],s=0;s<this.selectedItems.length;s++){var i,r,l=this.selectedItems[s];"string"==typeof l?r=i=l:(r=l[e.opts.tField],i=l[e.opts.vField]),t.push(r),o.push(i)}this.eles.$text.val(t.join(",")),this.eles.$hValue.val(o.join(",")),this.opts.onSelect&&this.opts.onSelect.call(this),this.setSubCombo()},xCombo.prototype.getParentFilterExpress=function(e){if($parentNode=jQuery(".combo[id="+this.eles.$selector.attr("pId")+"]"),$parentNode&&$parentNode.length>0){var t=combo.getCombo($parentNode);if(t){var o=t.getValue(),s=this.opts.pField;return o.toString().indexOf(e[s])>-1}}return!0},xCombo.prototype.FilterForParent=function(){var e=this;this.renderItems(this.opts.data,function(t){return e.getParentFilterExpress(t)})},xCombo.prototype.isFirstTime=!0,xCombo.prototype.setSubCombo=function(){if(this.isFirstTime)return void(this.isFirstTime=!1);var e=this;if($subNode=jQuery(".combo[pId="+this.eles.$selector.attr("id")+"]"),$subNode&&$subNode.length>0){var t=combo.getCombo($subNode);if(t){var o=(this.getValue(),$subNode.attr("pField"));t.renderItems(t.opts.data,function(t){return t[o]==e.getValue()}),t.selectedItems=[],t.setValue("")}}};var combo=function(){var combos=[],members={getCombo:function(e){for(var t=0;t<combos.length;t++){var o=combos[t];if(o.opts.selector.attr("id")&&e.attr("id")&&o.opts.selector.attr("id")==e.attr("id"))return o}return null},render:function(selector){selector||($selectors=jQuery(".combo"));for(var me=this,i=0;i<$selectors.length;i++)!function(i){var seletor=$selectors[i],$seletor=jQuery(seletor),opts={};opts.selector=$seletor,opts.tField=$seletor.attr("tField");var _data={};eval("(_data={data:"+($seletor.attr("data")||"[]")+"})"),opts.data=_data.data,opts.vField=$seletor.attr("vField"),opts.onLoadData=$seletor.attr("onLoadData"),opts.pField=$seletor.attr("pField"),opts.subNode=$seletor.attr("subNode"),opts.value=$seletor.attr("value")||jQuery(">input:first",$seletor).val(),opts.isMultiSelect=$seletor.attr("isMultiSelect");var xcombox=new xCombo;opts.onSelect=function(){var me=this,onSelect=this.eles.$selector.attr("onSelect");onSelect&&eval(onSelect+".call($seletor,me.getValue(),me.getText())")},combos.push(xcombox),xcombox.render(opts)}(i)},getValue:function(e){},setValue:function(e){}};return members}(),xForm=function(e){var t={select:function(){return"undefined"!=typeof select?select:{render:function(){}}},combo:function(){return"undefined"!=typeof combo?combo:{render:function(){}}},render:function(){this.select().render(),this.combo().render()}};return t}(window);jQuery(function(){xForm.render()}),xSelect.prototype.hide=function(){this.onHide(),this.eles.$ul.hide()},xSelect.prototype.show=function(){this.parentFilter(),this.onShow(),this.eles.$ul.show()},xSelect.prototype.render=function(e){var t=this,o=e.selector;e.onShow||function(){},e.onHide||function(){};this.opts=e;var s=o,i=jQuery(">ul",s);this.eles.$ul=i,this.eles.$selector=s;var r=jQuery(">li",i),l=jQuery(">input",s),n=s.attr("rendered");if("Y"!=n){this.eles.$text=l;var a=jQuery('<input type="hidden" />');this.eles.$hValue=a;var u=l.attr("name");u&&(a.attr("name",u),l.attr("name",u+"Desc")),s.append(a),i.css("top",s.height()+2+"px");var c=l.val()||s.attr("value");if(s.attr("rendered","Y"),void 0==c||""==c){var p=jQuery(">li[isSelected=Y]",i);if(p.size()>0){var h=0==p.attr("value")?p.text():p.attr("value");p.attr("value")!=h&&p.attr("value",h),c=h}}t.setValue(c,!0),s.on("click",function(e){var o=i.is(":visible");o?t.hide():t.show(),e.stopPropagation()}),r.on("click",function(e){var o=0==jQuery(this).attr("value")?jQuery(this).text():jQuery(this).attr("value"),s=t.getValue();s!=o&&(jQuery(this).attr("value")!=o&&jQuery(this).attr("value",o),t.setValue(o),t.hide(),e.stopPropagation())})}},xSelect.prototype.refresh=function(){},xSelect.prototype.filter=function(){},xSelect.prototype.setSubValue=function(){this.opts.subSelect&&this.opts.subSelect.setValue("")},xSelect.prototype.parentFilter=function(){if(this.opts.parentSelect){var e=this.opts.parentSelect.getValue();jQuery(">li",this.eles.$ul).hide(),jQuery(">li["+this.opts.pField+"="+e+"]",this.eles.$ul).show()}},xSelect.prototype.getValue=function(){return this.eles.$hValue.val()},xSelect.prototype.getText=function(){return this.eles.$text.val()},xSelect.prototype.onShow=function(){var onShow=this.opts.onShow;onShow&&eval(onShow+".call(this)")},xSelect.prototype.onHide=function(){var onHide=this.opts.onHide;onHide&&eval(onHide+".call(this)")},xSelect.prototype.setValue=function(e){var t=this.eles.$selector,o=jQuery(">ul",t),s=(jQuery(">li",o),jQuery(">input:first",t)),i=jQuery(">input[type=hidden]",t),r=jQuery(">li[value="+e+"]",o).text();r?(s.val(r),i.val(e)):(s.val(e),i.val(e)),this.onSelect(),this.setSubValue()},xSelect.prototype.onSelect=function(){var onSelect=this.opts.onSelect;"function"==typeof this.opts.onSelect?this.opts.onSelect.call(this,me.getValue(),me.getText()):onSelect&&eval(onSelect+".call(this,this.getValue(),this.getText())")},xSelect.prototype.onItemClick=function(){};var select=function(e){var t=[],o={getSelect:function(e){for(var o=0;o<t.length;o++){var s=t[o];if(s.opts.selector.attr("id")&&e.attr("id")&&s.opts.selector.attr("id")==e.attr("id"))return s}return null},getSubSelect:function(e){return $subNode=jQuery(".select[pId="+e.attr("id")+"]"),this.getSelect($subNode)},getParentSelect:function(e){$parentNode=jQuery(".select[id="+e.attr("pId")+"]");var t=this.getSelect($parentNode);return t&&(t.opts.subSelect=this.getSelect(e)),t},render:function(e,o){e||(e=".select"),o||(o={});var s=this;jQuery(e).each(function(e){var i=jQuery(this),r={};for(var e in o)r.item=o[e];r.pField=i.attr("pField"),r.onShow=i.attr("onShow"),r.onHide=i.attr("onHide"),r.onSelect=i.attr("onSelect"),r.selector=i;var l=new xSelect(r);t.push(l),l.render(r),r.subSelect=s.getSubSelect(i),r.parentSelect=s.getParentSelect(i)})}};return o}(window);